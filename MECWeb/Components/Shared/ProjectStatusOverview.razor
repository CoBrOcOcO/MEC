@using MECWeb.DbModels.Workflow
@using MECWeb.DbModels.Project
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

@implements IDisposable

<!-- PROJECT STATUS OVERVIEW COMPONENT -->
@if (workflows.Any())
{
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);">
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
                Projekt-Status Übersicht
            </MudText>

            <!-- Status Progress Bar -->
            <MudStack Row Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.Center" Class="my-2">
                <!-- Hardware Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetHardwareStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Computer"
                             Class="px-4 py-3 font-weight-bold"
                             Style="@GetHardwareStatusStyle()">
                        Hardware
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetHardwareStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Software Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetSoftwareStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Build"
                             Class="px-4 py-3 font-weight-bold"
                             Style="@GetSoftwareStatusStyle()">
                        Software
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetSoftwareStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Purchase Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetPurchaseStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.ShoppingCart"
                             Class="px-4 py-3 font-weight-bold"
                             Style="@GetPurchaseStatusStyle()">
                        Einkauf
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetPurchaseStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Installation Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetInstallationStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Construction"
                             Class="px-4 py-3 font-weight-bold"
                             Style="@GetInstallationStatusStyle()">
                        Installation
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetInstallationStatusText()
                    </MudText>
                </MudStack>
            </MudStack>

            <!-- Progress Indicator -->
            <MudProgressLinear Color="Color.Success" Value="@GetOverallProgress()" Size="Size.Small" Class="my-2" />

            <!-- Summary Stats -->
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Gesamtfortschritt: @GetOverallProgress().ToString("F0")%
                </MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @workflows.Count Workflow@(workflows.Count != 1 ? "s" : "") insgesamt
                </MudText>
            </MudStack>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] public Guid ProjectId { get; set; }
    [Parameter] public bool IsLoading { get; set; }

    private List<DbWorkflow> workflows = new();
    private System.Timers.Timer? _progressTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();

            workflows = await context.Workflow
                .AsNoTracking()
                .Where(w => w.ProjectId == ProjectId)
                .OrderBy(w => w.WorkflowType == WorkflowType.BDR ? 0 : 1)
                .ThenBy(w => w.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workflows in ProjectStatusOverview: {ex.Message}");
            workflows = new List<DbWorkflow>();
        }
    }

    public async Task RefreshAsync()
    {
        await LoadWorkflows();
        StateHasChanged();
    }

    // ==================== HARDWARE STATUS ====================

    // Get hardware status color based on workflow states
    private Color GetHardwareStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections affecting Hardware
        if (workflows.Any(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Hardware", StringComparison.OrdinalIgnoreCase)))
            return Color.Warning;

        // Dark green: Hardware was forwarded (Status >= Completed)
        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return Color.Dark;

        // light Green: Hardware completed, ready for forwarding to Software
        if (workflows.All(w => w.Status >= WorkflowStatus.SoftwareInProgress) &&
            workflows.All(w => w.Status < WorkflowStatus.Completed))
            return Color.Success;

        // Orange: Hardware in progress
        if (workflows.Any(w => w.Status >= WorkflowStatus.HardwareInProgress))
            return Color.Warning;

        // Grau: Not started
        return Color.Default;
    }

    // Get hardware status style for dark green
    private string GetHardwareStatusStyle()
    {
        if (!workflows.Any()) return "";

        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return "background-color: #2e7d32 !important; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);";

        return "box-shadow: 0 2px 8px rgba(0,0,0,0.1);";
    }

    // Get hardware status text
    private string GetHardwareStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Hardware", StringComparison.OrdinalIgnoreCase));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        // Dark Green: All forwarded
        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return "Weitergeleitet";

        // Light Green: All completed, ready for forwarding
        if (workflows.All(w => w.Status >= WorkflowStatus.SoftwareInProgress && w.Status < WorkflowStatus.Completed))
            return "Abgeschlossen";

        // Orange: In progress
        var completed = workflows.Count(w => w.Status >= WorkflowStatus.SoftwareInProgress);
        if (completed > 0) return $"{completed}/{workflows.Count}";

        return "Ausstehend";
    }

    // ==================== SOFTWARE STATUS ====================

    // Get software status color based on workflow states
    private Color GetSoftwareStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections affecting Software
        if (workflows.Any(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Software", StringComparison.OrdinalIgnoreCase)))
            return Color.Warning;

        // Dark Green: Software was forwarded (Status >= Completed)
        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return Color.Dark;

        // light Green: Software completed, ready for forwarding to Purchase
        if (workflows.All(w => w.Status == WorkflowStatus.SoftwareCompleted))
            return Color.Success;

        // Orange: Software in progress
        if (workflows.Any(w => w.Status >= WorkflowStatus.SoftwareInProgress))
            return Color.Warning;

        // Grau: Not started
        return Color.Default;
    }

    // Get software status style for dark green
    private string GetSoftwareStatusStyle()
    {
        if (!workflows.Any()) return "";

        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return "background-color: #2e7d32 !important; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);";

        return "box-shadow: 0 2px 8px rgba(0,0,0,0.1);";
    }

    // Get software status text
    private string GetSoftwareStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Software", StringComparison.OrdinalIgnoreCase));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        // Dark Green: All forwarded
        if (workflows.All(w => w.Status >= WorkflowStatus.Completed))
            return "Weitergeleitet";

        // light Green: All completed, ready for forwarding
        if (workflows.All(w => w.Status == WorkflowStatus.SoftwareCompleted))
            return "Abgeschlossen";

        // Orange: In progress
        var completed = workflows.Count(w => w.Status >= WorkflowStatus.SoftwareCompleted);
        if (completed > 0) return $"{completed}/{workflows.Count}";

        return "Ausstehend";
    }

    // ==================== PURCHASE STATUS ====================

    private Color GetPurchaseStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Dark Green: Purchase was forwarded to installation (Status >= ForwardedToInstallation)
        if (workflows.All(w => w.Status >= WorkflowStatus.ForwardedToInstallation))
            return Color.Dark;

        // Check if workflows are at purchase (Status = Completed)
        if (workflows.Any(w => w.Status == WorkflowStatus.Completed))
        {
            // Orange: Has pending corrections (released for correction from purchase)
            if (workflows.Any(w => w.HasPendingCorrection))
                return Color.Warning;

            // light Green: All purchase completed, ready for forwarding to Installation
            if (workflows.All(w => w.Status == WorkflowStatus.Completed && w.PurchaseCompleted))
                return Color.Success;

            // Orange: At purchase, but not all completed yet
            return Color.Warning;
        }

        // Grey: Not at purchase yet (Status < Completed)
        return Color.Default;
    }

    // Get purchase status style for dark green
    private string GetPurchaseStatusStyle()
    {
        if (!workflows.Any()) return "";

        if (workflows.All(w => w.Status >= WorkflowStatus.ForwardedToInstallation))
            return "background-color: #2e7d32 !important; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);";

        return "box-shadow: 0 2px 8px rgba(0,0,0,0.1);";
    }

    // Get purchase status text
    private string GetPurchaseStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        if (workflows.Any(w => w.HasPendingCorrection && w.Status == WorkflowStatus.Completed))
            return "Korrektur";

        // Dark Green All forwarded to installation
        if (workflows.All(w => w.Status >= WorkflowStatus.ForwardedToInstallation))
            return "Weitergeleitet";

        // Light Green: All purchase completed, ready for forwarding
        if (workflows.All(w => w.Status == WorkflowStatus.Completed && w.PurchaseCompleted))
            return "Abgeschlossen";

        // Orange: At purchase, in progress
        if (workflows.Any(w => w.Status == WorkflowStatus.Completed))
        {
            var completed = workflows.Count(w => w.PurchaseCompleted);
            return $"{completed}/{workflows.Count}";
        }

        return "Ausstehend";
    }

    // ==================== INSTALLATION STATUS ====================

    // Get installation status color based on workflow states
    private Color GetInstallationStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections in Installation phase
        if (workflows.Any(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Installation", StringComparison.OrdinalIgnoreCase)))
            return Color.Warning;

        // Dark Green: Installation archived (Status = Archived)
        if (workflows.All(w => w.Status == WorkflowStatus.Archived))
            return Color.Dark;

        // Orange: At installation, in progress (Status = ForwardedToInstallation)
        if (workflows.Any(w => w.Status == WorkflowStatus.ForwardedToInstallation))
            return Color.Warning;

        // Grey: Not at installation yet
        return Color.Default;
    }

    // Get installation status style for dark green
    private string GetInstallationStatusStyle()
    {
        if (!workflows.Any()) return "";

        if (workflows.All(w => w.Status == WorkflowStatus.Archived))
            return "background-color: #2e7d32 !important; box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);";

        return "box-shadow: 0 2px 8px rgba(0,0,0,0.1);";
    }

    // Get installation status text
    private string GetInstallationStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            !string.IsNullOrEmpty(w.CorrectionPhase) &&
            w.CorrectionPhase.Contains("Installation", StringComparison.OrdinalIgnoreCase));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        // Dark Green: All archived
        if (workflows.All(w => w.Status == WorkflowStatus.Archived))
            return "Abgeschlossen";

        // Orange: At installation
        var atInstallation = workflows.Count(w => w.Status >= WorkflowStatus.ForwardedToInstallation);
        if (atInstallation > 0) return $"{atInstallation}/{workflows.Count}";

        return "Ausstehend";
    }

    // ==================== PROGRESS CALCULATION ====================

    // Calculate overall project progress percentage
    private double GetOverallProgress()
    {
        if (!workflows.Any()) return 0;

        // Calculate progress based on workflow status
        double totalProgress = 0;
        foreach (var workflow in workflows)
        {
            totalProgress += workflow.Status switch
            {
                WorkflowStatus.Created => 0,
                WorkflowStatus.HardwareInProgress => 15,
                WorkflowStatus.SoftwareInProgress => 40,
                WorkflowStatus.SoftwareCompleted => 60,
                WorkflowStatus.Completed => 75,
                WorkflowStatus.ForwardedToInstallation => 90,
                WorkflowStatus.Archived => 100,
                _ => 0
            };
        }

        return totalProgress / workflows.Count;
    }

    // ==================== LIFECYCLE ====================

    public void Dispose()
    {
        _progressTimer?.Dispose();
    }
}