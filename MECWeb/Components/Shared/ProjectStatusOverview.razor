@using MECWeb.DbModels.Workflow
@using MECWeb.DbModels.Project
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext

@implements IDisposable

<!-- PROJECT STATUS OVERVIEW COMPONENT -->
@if (workflows.Any())
{
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);">
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
                Projekt-Status Übersicht
            </MudText>

            <!-- Status Progress Bar -->
            <MudStack Row Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.Center" Class="my-2">
                <!-- Hardware Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetHardwareStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Computer"
                             Class="px-4 py-3 font-weight-bold"
                             Style="min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        Hardware
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetHardwareStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Software Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetSoftwareStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Build"
                             Class="px-4 py-3 font-weight-bold"
                             Style="min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        Software
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetSoftwareStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Purchase Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetPurchaseStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.ShoppingCart"
                             Class="px-4 py-3 font-weight-bold"
                             Style="min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        Einkauf
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetPurchaseStatusText()
                    </MudText>
                </MudStack>

                <!-- Arrow -->
                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Secondary" Size="Size.Medium" />

                <!-- Installation Status -->
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    <MudChip T="string"
                             Size="Size.Medium"
                             Color="@GetInstallationStatusColor()"
                             Variant="Variant.Filled"
                             Icon="@Icons.Material.Filled.Construction"
                             Class="px-4 py-3 font-weight-bold"
                             Style="min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        Installation
                    </MudChip>
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                        @GetInstallationStatusText()
                    </MudText>
                </MudStack>
            </MudStack>

            <!-- Progress Bar -->
            <MudProgressLinear Color="Color.Success"
                               Value="@_animatedProgress"
                               Size="Size.Large"
                               Rounded="true"
                               Class="my-2"
                               Style="height: 12px;" />

            <!-- Overall Progress Information -->
            <MudDivider />
            <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row Spacing="3">
                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" Icon="@Icons.Material.Filled.Computer">
                        @workflows.Count(w => w.WorkflowType == WorkflowType.BDR) BDR
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text" Icon="@Icons.Material.Filled.CameraAlt">
                        @workflows.Count(w => w.WorkflowType == WorkflowType.BV) BV
                    </MudChip>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text" Icon="@Icons.Material.Filled.CheckCircle">
                        @workflows.Count Gesamt
                    </MudChip>
                </MudStack>
                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled" Style="font-weight: 600;">
                    @GetCompletionPercentage()% abgeschlossen
                </MudChip>
            </MudStack>
        </MudStack>
    </MudPaper>
}
else if (IsLoading)
{
    <!-- Loading State -->
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background-color: var(--mud-palette-background-grey);">
        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
            <MudText Typo="Typo.body2" Color="Color.Secondary">Projekt-Status wird geladen...</MudText>
        </MudStack>
    </MudPaper>
}
else
{
    <!-- No Workflows State -->
    <MudPaper Class="pa-4 mb-4" Elevation="2" Style="background-color: var(--mud-palette-background-grey);">
        <MudStack AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Secondary" />
            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                Noch keine Formulare für dieses Projekt erstellt.
            </MudText>
        </MudStack>
    </MudPaper>
}

@code {
    [Parameter] public Guid ProjectId { get; set; }
    [Parameter] public bool IsLoading { get; set; } = false;

    private List<DbWorkflow> workflows = new();
    private double _animatedProgress = 0;
    private System.Threading.Timer? _progressTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflows();
    }

    private async Task LoadWorkflows()
    {
        try
        {
            workflows = await DbContext.Workflow
                .Where(w => w.ProjectId == ProjectId)
                .OrderBy(w => w.WorkflowType == WorkflowType.BDR ? 0 : 1)
                .ThenBy(w => w.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workflows in ProjectStatusOverview: {ex.Message}");
            workflows = new List<DbWorkflow>();
        }
    }

    public async Task RefreshAsync()
    {
        await LoadWorkflows();
        StateHasChanged();
    }

    // STATUS COLOR METHODS WITH IMPROVED CORRECTION LOGIC
    private Color GetHardwareStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections in Hardware phase
        if (workflows.Any(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Hardware || w.CorrectionPhase == "Hardware")))
            return Color.Warning;

        // Check if all workflows have completed hardware
        var allCompleted = workflows.All(w => w.Status >= WorkflowStatus.SoftwareInProgress);
        var someStarted = workflows.Any(w => w.Status >= WorkflowStatus.HardwareInProgress);
        var anyInProgress = workflows.Any(w => w.Status == WorkflowStatus.HardwareInProgress);

        if (allCompleted) return Color.Success;
        if (anyInProgress) return Color.Warning;
        if (someStarted) return Color.Warning;
        return Color.Default;
    }

    private Color GetSoftwareStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections in Software phase
        if (workflows.Any(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Software || w.CorrectionPhase == "Software")))
            return Color.Warning;

        // Check if all workflows have completed software
        var allCompleted = workflows.All(w => w.Status >= WorkflowStatus.SoftwareCompleted);
        var someStarted = workflows.Any(w => w.Status >= WorkflowStatus.SoftwareInProgress);
        var anyInProgress = workflows.Any(w => w.Status == WorkflowStatus.SoftwareInProgress);

        if (allCompleted) return Color.Success;
        if (anyInProgress) return Color.Warning;
        if (someStarted) return Color.Warning;
        return Color.Default;
    }

    private Color GetPurchaseStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections in Purchase phase
        if (workflows.Any(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Purchase || w.CorrectionPhase == "Purchase")))
            return Color.Warning;

        // Check if all software is completed (prerequisite for purchase)
        var allSoftwareCompleted = workflows.All(w => w.Status >= WorkflowStatus.SoftwareCompleted);
        if (!allSoftwareCompleted) return Color.Default;

        // Check purchase status
        var allCompletedPurchase = workflows.All(w => w.Status >= WorkflowStatus.ForwardedToInstallation);
        var somePurchaseStarted = workflows.Any(w => w.Status >= WorkflowStatus.Completed);
        var anyInProgress = workflows.Any(w => w.Status == WorkflowStatus.Completed &&
                                               w.Status < WorkflowStatus.ForwardedToInstallation);

        if (allCompletedPurchase) return Color.Success;
        if (anyInProgress) return Color.Warning;
        if (somePurchaseStarted) return Color.Warning;
        return Color.Default;
    }

    private Color GetInstallationStatusColor()
    {
        if (!workflows.Any()) return Color.Default;

        // Check for pending corrections in Installation phase
        if (workflows.Any(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Installation || w.CorrectionPhase == "Installation")))
            return Color.Warning;

        // Check if any workflows are at installation
        var someForwardedToInstallation = workflows.Any(w => w.Status >= WorkflowStatus.ForwardedToInstallation);
        if (!someForwardedToInstallation) return Color.Default;

        // Check installation status
        var allCompleted = workflows.All(w => w.Status >= WorkflowStatus.Archived);
        var anyInProgress = workflows.Any(w => w.Status >= WorkflowStatus.ForwardedToInstallation &&
                                               w.Status < WorkflowStatus.Archived);

        if (allCompleted) return Color.Success;
        if (anyInProgress) return Color.Warning;
        return Color.Warning;
    }

    // STATUS TEXT METHODS
    private string GetHardwareStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Hardware || w.CorrectionPhase == "Hardware"));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        var completed = workflows.Count(w => w.Status >= WorkflowStatus.SoftwareInProgress);
        if (completed == workflows.Count) return "Abgeschlossen";
        if (completed > 0) return $"{completed}/{workflows.Count}";
        return "Ausstehend";
    }

    private string GetSoftwareStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Software || w.CorrectionPhase == "Software"));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        var completed = workflows.Count(w => w.Status >= WorkflowStatus.SoftwareCompleted);
        if (completed == workflows.Count) return "Abgeschlossen";
        if (completed > 0) return $"{completed}/{workflows.Count}";
        return "Ausstehend";
    }

    private string GetPurchaseStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Purchase || w.CorrectionPhase == "Purchase"));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        var completed = workflows.Count(w => w.Status >= WorkflowStatus.ForwardedToInstallation);
        if (completed == workflows.Count) return "Abgeschlossen";

        var atPurchase = workflows.Count(w => w.Status >= WorkflowStatus.Completed);
        if (atPurchase > 0) return $"{atPurchase}/{workflows.Count}";
        return "Ausstehend";
    }

    private string GetInstallationStatusText()
    {
        if (!workflows.Any()) return "Ausstehend";

        // Check for corrections
        var correctionsCount = workflows.Count(w => w.HasPendingCorrection &&
            (w.CorrectionPhase == WorkflowPhase.Installation || w.CorrectionPhase == "Installation"));
        if (correctionsCount > 0) return $"Korrektur ({correctionsCount})";

        var completed = workflows.Count(w => w.Status >= WorkflowStatus.Archived);
        if (completed == workflows.Count) return "Abgeschlossen";

        var atInstallation = workflows.Count(w => w.Status >= WorkflowStatus.ForwardedToInstallation);
        if (atInstallation > 0) return $"{atInstallation}/{workflows.Count}";
        return "Ausstehend";
    }

    private int GetCompletionPercentage()
    {
        if (!workflows.Any()) return 0;

        var totalSteps = workflows.Count * 7;
        var completedSteps = 0;

        foreach (var workflow in workflows)
        {
            if (workflow.Status >= WorkflowStatus.HardwareInProgress) completedSteps++;
            if (workflow.Status >= WorkflowStatus.SoftwareInProgress) completedSteps++;
            if (workflow.Status >= WorkflowStatus.SoftwareInProgress) completedSteps++;
            if (workflow.Status >= WorkflowStatus.SoftwareCompleted) completedSteps++;
            if (workflow.Status >= WorkflowStatus.Completed) completedSteps++;
            if (workflow.Status >= WorkflowStatus.ForwardedToInstallation) completedSteps++;
            if (workflow.Status >= WorkflowStatus.Archived) completedSteps++;
        }

        return (int)Math.Round((double)completedSteps / totalSteps * 100);
    }

    private Task AnimateProgress(int targetPercentage)
    {
        _progressTimer?.Dispose();

        double startValue = _animatedProgress;
        const int animationDurationMs = 1000;
        const int updateIntervalMs = 16;
        int steps = animationDurationMs / updateIntervalMs;
        double increment = (targetPercentage - startValue) / steps;

        _progressTimer = new System.Threading.Timer(async _ =>
        {
            _animatedProgress = Math.Min(_animatedProgress + increment, targetPercentage);
            await InvokeAsync(StateHasChanged);

            if (Math.Abs(_animatedProgress - targetPercentage) < 0.1)
            {
                _animatedProgress = targetPercentage;
                _progressTimer?.Dispose();
                await InvokeAsync(StateHasChanged);
            }
        }, null, 0, updateIntervalMs);

        return Task.CompletedTask;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ProjectId != Guid.Empty)
        {
            await LoadWorkflows();
            await AnimateProgress(GetCompletionPercentage());
        }
    }

    public void Dispose()
    {
        _progressTimer?.Dispose();
    }
}