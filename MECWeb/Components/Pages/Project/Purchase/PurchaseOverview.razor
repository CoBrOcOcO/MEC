@page "/purchase/orders"
@using MECWeb.DbModels.Workflow
@using MECWeb.DbModels.Project
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.WebUtilities
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@layout MainLayout
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Large" Style="margin-top: 50px;">
    <MudStack Spacing="4">
        <!-- Header Section -->
        <MudStack Spacing="3">
            <MudText Typo="Typo.h4" Align="Align.Center">
                Einkauf
            </MudText>
            <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Secondary">
                @activeProjects.Count Projekte zur Bestellung
            </MudText>

            <!-- Search Field -->
            <MudTextField @bind-Value="searchQuery"
                          Immediate="true"
                          DebounceInterval="300"
                          OnDebounceIntervalElapsed="FilterProjects"
                          Placeholder="Projekt suchen..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="mt-4" />
        </MudStack>

        <!-- Loading -->
        @if (loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }

        <!-- Active Projects -->
        @if (filteredActiveProjects.Any())
        {
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-4">Aktive Bestellungen</MudText>
            <MudStack Spacing="3">
                @foreach (var project in filteredActiveProjects)
                {
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <!-- Project Info -->
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.h6">@project.ProjectNumber</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@project.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                    @project.Workflows.Count(w => w.Status == WorkflowStatus.Completed && !w.HasPendingCorrection) Formulare zur Bestellung
                                </MudText>
                            </MudStack>

                            <!-- Actions -->
                            <MudStack Row Spacing="2">
                                <MudButton Color="Color.Primary"
                                           Variant="Variant.Outlined"
                                           Size="Size.Medium"
                                           OnClick="() => ViewProjectDetails(project.Id)">
                                    Details
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        }

        <!-- Forwarded Projects -->
        @if (filteredForwardedProjects.Any())
        {
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-6">Bereits an Installation weitergeleitet</MudText>
            <MudStack Spacing="3">
                @foreach (var project in filteredForwardedProjects)
                {
                    <MudPaper Class="pa-4" Elevation="1" Style="opacity: 0.8;">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <!-- Project Info -->
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.h6">@project.ProjectNumber</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">@project.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Success">
                                    An Installation weitergeleitet
                                </MudText>
                            </MudStack>

                            <!-- Action Button -->
                            <MudButton Color="Color.Secondary"
                                       Variant="Variant.Outlined"
                                       Size="Size.Medium"
                                       OnClick="() => ViewProjectDetails(project.Id, isForwarded: true)">
                                Details
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        }

        <!-- Empty State -->
        @if (!loading && !filteredActiveProjects.Any() && !filteredForwardedProjects.Any())
        {
            <MudStack AlignItems="AlignItems.Center" Class="mt-6">
                <MudImage Src="assets/systemstatus/empty_state_V1.png" Alt="Empty" Width="150" Class="ma-6" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">Keine Bestellungen gefunden</MudText>
            </MudStack>
        }

        <!-- Back Button -->
        <MudButton Variant="Variant.Text"
                   Size="Size.Small"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="GoBack"
                   Class="px-3 py-1">
            Zurück zur Projektübersicht
        </MudButton>
    </MudStack>
</MudContainer>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private List<DbProject> activeProjects = new();
    private List<DbProject> forwardedProjects = new();
    private List<DbProject> filteredActiveProjects = new();
    private List<DbProject> filteredForwardedProjects = new();
    private bool loading = true;
    private string searchQuery = "";

    // Auto-refresh timer
    private System.Threading.Timer? _autoRefreshTimer;
    private const int AUTO_REFRESH_INTERVAL_MS = 10000; // Reduced to 10 seconds for faster updates

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes to reload data when navigating to this page
        Navigation.LocationChanged += OnLocationChanged;

        await LoadProjects();

        // Setup auto-refresh timer
        _autoRefreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadProjects();
                StateHasChanged();
            });
        }, null, AUTO_REFRESH_INTERVAL_MS, AUTO_REFRESH_INTERVAL_MS);
    }

    protected override async Task OnParametersSetAsync()
    {
        // This ensures the page refreshes when navigating to it with parameters
        await LoadProjects();
    }

    public void Dispose()
    {
        // Clean up navigation event subscription
        Navigation.LocationChanged -= OnLocationChanged;
        _autoRefreshTimer?.Dispose();
    }

    /// <summary>
    /// Handle navigation changes - reload data when user navigates to this page
    /// </summary>
    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Only reload if we're navigating TO this page (not away from it)
        if (e.Location.Contains("/purchase/orders"))
        {
            await InvokeAsync(async () =>
            {
                await LoadProjects();
                StateHasChanged();
            });
        }
    }

    /// <summary>
    /// Load all projects with purchase-relevant workflows
    /// EXCLUDES projects with pending corrections
    /// </summary>
    private async Task LoadProjects()
    {
        loading = true;
        try
        {
            var allProjects = await DbContext.Project
                .Include(p => p.Workflows)
                .Where(p => p.Workflows.Any(w =>
                    w.Status == WorkflowStatus.Completed ||
                    w.Status == WorkflowStatus.ForwardedToInstallation))
                .OrderByDescending(p => p.LastChange)
                .ToListAsync();

            // Active projects (at purchase department - Completed status WITHOUT pending correction)
            activeProjects = allProjects
                .Where(p => p.Workflows.Any(w =>
                    w.Status == WorkflowStatus.Completed &&
                    !w.HasPendingCorrection))
                .ToList();

            // Forwarded projects (already forwarded to installation - ForwardedToInstallation status)
            forwardedProjects = allProjects
                .Where(p => p.Workflows.All(w => w.Status == WorkflowStatus.ForwardedToInstallation) &&
                           p.Workflows.Any(w => w.Status == WorkflowStatus.ForwardedToInstallation))
                .ToList();

            FilterProjects();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading projects: {ex.Message}");
            Snackbar.Add($"Fehler beim Laden der Projekte: {ex.Message}", Severity.Error);
            activeProjects = new List<DbProject>();
            forwardedProjects = new List<DbProject>();
        }
        finally
        {
            loading = false;
        }
    }

    /// <summary>
    /// Filter projects based on search query
    /// </summary>
    private void FilterProjects()
    {
        var query = searchQuery.Trim().ToLower();

        if (string.IsNullOrEmpty(query))
        {
            filteredActiveProjects = activeProjects;
            filteredForwardedProjects = forwardedProjects;
        }
        else
        {
            filteredActiveProjects = activeProjects
                .Where(p => p.ProjectNumber.ToLower().Contains(query) ||
                           p.Name.ToLower().Contains(query))
                .ToList();

            filteredForwardedProjects = forwardedProjects
                .Where(p => p.ProjectNumber.ToLower().Contains(query) ||
                           p.Name.ToLower().Contains(query))
                .ToList();
        }

        // Trigger UI update
        StateHasChanged();
    }

    /// <summary>
    /// Navigate to project details view
    /// </summary>
    private void ViewProjectDetails(Guid projectId, bool isForwarded = false)
    {
        var queryParams = new Dictionary<string, string?>();

        if (isForwarded)
        {
            queryParams.Add("readOnly", "true");
        }

        queryParams.Add("returnPath", "overview");

        var url = QueryHelpers.AddQueryString($"/purchase/project/{projectId}", queryParams);
        Navigation.NavigateTo(url);
    }

    /// <summary>
    /// Navigate back to projects overview
    /// </summary>
    private void GoBack()
    {
        if (!string.IsNullOrEmpty(ReturnUrl))
        {
            Navigation.NavigateTo(ReturnUrl);
        }
        else
        {
            Navigation.NavigateTo("/projects");
        }
    }
}