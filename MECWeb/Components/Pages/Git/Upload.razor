@using MECWeb.Models.Gitea
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using System.IO
@inject GiteaService GiteaService
@inject ISnackbar Snackbar

<MudDialog Style="min-width: 600px;">
    <DialogContent>
        <MudStack Spacing="3">

            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Upload" Color="Color.Primary" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5">Datei einchecken</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Datei in das Repository hochladen und versionieren
                    </MudText>
                </MudStack>
            </MudStack>

            <MudDivider />

            <MudAlert Severity="Severity.Info" Dense="true">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2">
                        <strong>Repository:</strong> @RepositoryOwner/@RepositoryName
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Ziel-Pfad:</strong> @GetTargetPathDisplay()
                    </MudText>
                </MudStack>
            </MudAlert>

            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle1">
                    <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Style="margin-right: 4px;" />
                    Datei auswählen
                </MudText>

                <!-- Vereinfachter Upload-Button  -->

                <InputFile OnChange="OnFileSelected" id="fileInput" style="display: none;" />
                <MudButton HtmlTag="label"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.AttachFile"
                           for="fileInput">
                    Datei auswählen...
                </MudButton>

                @if (selectedFile != null)
                {
                    <MudAlert Severity="Severity.Success" Dense="true">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetFileIcon(selectedFile.Name)" />
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">
                                        <strong>@selectedFile.Name</strong>
                                    </MudText>
                                    <MudText Typo="Typo.caption">
                                        @FormatFileSize(selectedFile.Size)
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            <MudIconButton Icon="@Icons.Material.Filled.Clear"
                                           Size="Size.Small"
                                           OnClick="ClearFile" />
                        </MudStack>
                    </MudAlert>
                }
            </MudStack>
            
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle1">
                    <MudIcon Icon="@Icons.Material.Filled.Message" Size="Size.Small" Style="margin-right: 4px;" />
                    Commit-Nachricht *
                </MudText>
                <MudTextField @bind-Value="commitMessage"
                              Label="Beschreibung der Änderung"
                              Lines="2"
                              Placeholder="Beschreibe deine Änderung..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Comment"
                              Error="@(hasTriedUpload && !IsValidCommitMessage())"
                              ErrorText="Eigene Commit-Nachricht ist erforderlich" />
            </MudStack>

            @if (isUploading)
            {
                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <MudText>@uploadStatus</MudText>
                    </MudStack>
                </MudAlert>
            }

        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">
            Abbrechen
        </MudButton>
        <MudButton OnClick="StartUpload"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.CloudUpload"
                   Disabled="@(selectedFile == null || isUploading)">
            @if (isUploading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="margin-right: 8px;" />
                <span>Wird eingecheckt...</span>
            }
            else
            {
                <span>Einchecken</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string RepositoryOwner { get; set; } = "";
    [Parameter] public string RepositoryName { get; set; } = "";
    [Parameter] public string CurrentPath { get; set; } = "";
    [Parameter] public EventCallback OnUploadSuccess { get; set; }

    private IBrowserFile? selectedFile;
    private string commitMessage = "";
    private bool isUploading = false;
    private string uploadStatus = "";
    private bool hasTriedUpload = false;

    private bool IsValidCommitMessage()
    {
        if (string.IsNullOrWhiteSpace(commitMessage))
            return false;
            
        var trimmed = commitMessage.Trim();
        return trimmed.Length > 3; // Mindestens 4 Zeichen
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        StateHasChanged();
    }

    private void ClearFile()
    {
        selectedFile = null;
        StateHasChanged();
    }

    private string GetTargetPathDisplay()
    {
        return string.IsNullOrEmpty(CurrentPath) ? "/" : $"/{CurrentPath}";
    }

    private string GetFullTargetPath()
    {
        if (selectedFile == null) return "";
        var fileName = selectedFile.Name;
        if (string.IsNullOrEmpty(CurrentPath))
            return fileName;
        return $"{CurrentPath}/{fileName}";
    }

    private string GetFileIcon(string fileName)
    {
        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".doc" or ".docx" => Icons.Material.Filled.Description,
            ".jpg" or ".jpeg" or ".png" or ".gif" => Icons.Material.Filled.Image,
            ".zip" or ".rar" or ".7z" => Icons.Material.Filled.Archive,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024:F1} KB";
        if (bytes < 1024 * 1024 * 1024) return $"{bytes / (1024 * 1024):F1} MB";
        return $"{bytes / (1024 * 1024 * 1024):F1} GB";
    }

    private async Task StartUpload()
    {
        hasTriedUpload = true;
        if (!IsValidCommitMessage())
        {
            Snackbar.Add("Bitte eine gültige Commit-Nachricht eingeben (mind. 4 Zeichen).", Severity.Error);
            StateHasChanged();
            return;
        }
        
        if (selectedFile == null || isUploading) return;

        isUploading = true;
        uploadStatus = "Datei wird vorbereitet...";
        StateHasChanged();

        try
        {
            var fullPath = GetFullTargetPath();
            var message = commitMessage.Trim();
            
            uploadStatus = $"Lade Datei hoch (kann bei großen Dateien dauern)...";
            StateHasChanged();

            long maxFileSize = 2_000_000_000; // 2GB Limit
            
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: maxFileSize);

            var success = await GiteaService.UploadFileViaLfsAsync(
                RepositoryOwner,
                RepositoryName,
                fullPath,
                stream,
                message);

            if (success)
            {
                uploadStatus = "Erfolgreich eingecheckt!";
                Snackbar.Add($"Datei '{selectedFile.Name}' erfolgreich eingecheckt!", Severity.Success);
                await Task.Delay(1000); 

                if (OnUploadSuccess.HasDelegate)
                {
                    await OnUploadSuccess.InvokeAsync();
                }
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                uploadStatus = "Einchecken fehlgeschlagen!";
                Snackbar.Add("Einchecken fehlgeschlagen. Siehe Server-Logs für Details.", Severity.Error);
                isUploading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            uploadStatus = $"Fehler: {ex.Message}";
            Snackbar.Add($"Upload-Fehler: {ex.Message}", Severity.Error);
            isUploading = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}

