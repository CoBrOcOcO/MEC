@page "/git"
@using MECWeb.Services
@using MECWeb.Models.Gitea
@inject GiteaService GiteaService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Git Dashboard - MECWeb</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">


    @* Header Section - Similar to PDF Header *@
    <MudPaper Class="pa-6 mb-4" Elevation="0" Style="border-bottom: 3px solid #00873C;">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: #00873C; font-weight: 600;">Git Management Dashboard</MudText>
                <MudText Typo="Typo.body2" Style="color: #666;">
                    Verwalten Sie Ihre Git-Repositories, laden Sie Dateien hoch und erstellen Sie neue Projekte
                </MudText>
            </MudStack>
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Style="font-size: 3rem; color: #00873C;" />
        </MudStack>
    </MudPaper>

    @* Quick Stats - Clean table-like design *@
    <MudPaper Class="mb-4 pa-4" Elevation="1" Style="border: 1px solid #e0e0e0;">
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00873C; font-weight: 600; border-bottom: 2px solid #00873C; padding-bottom: 8px;">
            Übersicht
        </MudText>
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudStack Spacing="1" Style="padding: 12px; border-left: 3px solid #00873C; background-color: #fafafa;">
                    <MudText Typo="Typo.body2" Style="color: #666; font-size: 0.85rem;">Repositories</MudText>
                    <MudText Typo="Typo.h5" Style="color: #00873C; font-weight: 600;">@repositoryCount</MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudStack Spacing="1" Style="padding: 12px; border-left: 3px solid #00873C; background-color: #fafafa;">
                    <MudText Typo="Typo.body2" Style="color: #666; font-size: 0.85rem;">Uploads Heute</MudText>
                    <MudText Typo="Typo.h5" Style="color: #00873C; font-weight: 600;">@todayUploads</MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudStack Spacing="1" Style="padding: 12px; border-left: 3px solid #00873C; background-color: #fafafa;">
                    <MudText Typo="Typo.body2" Style="color: #666; font-size: 0.85rem;">Commits</MudText>
                    <MudText Typo="Typo.h5" Style="color: #00873C; font-weight: 600;">@totalCommits</MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudStack Spacing="1" Style="padding: 12px; border-left: 3px solid #00873C; background-color: #fafafa;">
                    <MudText Typo="Typo.body2" Style="color: #666; font-size: 0.85rem;">Gitea Status</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@connectionStatus.icon" Size="Size.Small" Color="@connectionStatus.color" />
                        <MudText Typo="Typo.body1" Style="font-weight: 600;" Color="@connectionStatus.color">@connectionStatus.text</MudText>
                    </MudStack>
                </MudStack>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* Quick Actions and Recent Activity *@
    <MudGrid Class="mb-4">
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Style="border: 1px solid #e0e0e0; height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00873C; font-weight: 600; border-bottom: 2px solid #00873C; padding-bottom: 8px;">
                    Schnellaktionen
                </MudText>

                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Add"
                               FullWidth="true"
                               Href="/git/create-repository"
                               Style="background-color: #00873C; color: white; text-transform: none; padding: 12px;">
                        Neues Repository erstellen
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Upload"
                               FullWidth="true"
                               Href="/git/upload"
                               Style="border-color: #e0e0e0; color: #333; text-transform: none; padding: 12px;">
                        Datei hochladen
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Storage"
                               FullWidth="true"
                               Href="/git/repositories"
                               Style="border-color: #e0e0e0; color: #333; text-transform: none; padding: 12px;">
                        Repositories durchsuchen
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1" Style="border: 1px solid #e0e0e0; height: 100%;">
                <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00873C; font-weight: 600; border-bottom: 2px solid #00873C; padding-bottom: 8px;">
                    Letzte Aktivitäten
                </MudText>

                @if (recentRepositories?.Any() == true)
                {
                    <MudTable Items="@recentRepositories.Take(5)" 
                              Dense="true" 
                              Hover="true"
                              Style="border: 1px solid #e0e0e0;"
                              Elevation="0">
                        <HeaderContent>
                            <MudTh Style="background-color: #f5f5f5; color: #333; font-weight: 600; border-bottom: 2px solid #e0e0e0;">Repository</MudTh>
                            <MudTh Style="background-color: #f5f5f5; color: #333; font-weight: 600; border-bottom: 2px solid #e0e0e0;">Besitzer</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd Style="border-bottom: 1px solid #e0e0e0; cursor: pointer;" @onclick="@(() => NavigateToRepository(context))">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Style="color: #00873C;" />
                                    <MudText Typo="Typo.body2">@context.Name</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd Style="border-bottom: 1px solid #e0e0e0;">
                                <MudText Typo="Typo.body2" Style="color: #666;">@context.Owner?.Login</MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" 
                              Dense="true"
                              Style="background-color: #f5f5f5; border-left: 4px solid #00873C; color: #333;">
                        Noch keine Repositories verfügbar. Erstellen Sie Ihr erstes Repository!
                    </MudAlert>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* System Status *@
    <MudPaper Class="pa-4" Elevation="1" Style="border: 1px solid #e0e0e0;">
        <MudText Typo="Typo.h6" Class="mb-3" Style="color: #00873C; font-weight: 600; border-bottom: 2px solid #00873C; padding-bottom: 8px;">
            System-Status
        </MudText>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" 
                              Style="padding: 12px; border: 1px solid #e0e0e0; background-color: #fafafa;">
                        <MudText Typo="Typo.body2" Style="color: #666; font-weight: 600;">Gitea-Verbindung:</MudText>
                        <MudChip T="string"
                                 Color="@connectionStatus.color"
                                 Icon="@connectionStatus.icon"
                                 Size="Size.Small">
                            @connectionStatus.text
                        </MudChip>
                    </MudStack>

                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center"
                              Style="padding: 12px; border: 1px solid #e0e0e0; background-color: #fafafa;">
                        <MudText Typo="Typo.body2" Style="color: #666; font-weight: 600;">Letzte Synchronisation:</MudText>
                        <MudText Typo="Typo.body2" Style="color: #333;">
                            @lastSyncTime.ToString("dd.MM.yyyy HH:mm")
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6" Style="display: flex; align-items: center;">
                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RefreshData"
                           Disabled="@isLoading"
                           FullWidth="true"
                           Style="background-color: #00873C; color: white; text-transform: none; padding: 12px;">
                    @if (isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" Style="color: white;" />
                        <span>Lädt...</span>
                    }
                    else
                    {
                        <span>Daten aktualisieren</span>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

</MudContainer>

@code {
    private List<GiteaRepository> recentRepositories = new();
    private int repositoryCount = 0;
    private int todayUploads = 12; // Placeholder
    private int totalCommits = 0;
    private DateTime lastSyncTime = DateTime.Now;
    private bool isLoading = false;

    private (string icon, Color color, string text) connectionStatus =
        (Icons.Material.Filled.HelpOutline, Color.Default, "Wird getestet...");

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Test Gitea connection
            var repos = await GiteaService.GetUserRepositoriesAsync();
            recentRepositories = repos ?? new List<GiteaRepository>();

            if (recentRepositories != null)
            {
                repositoryCount = recentRepositories.Count;
                connectionStatus = (Icons.Material.Filled.CheckCircle, Color.Success, "Verbunden");

                // Calculate total commits (placeholder logic)
                totalCommits = repositoryCount * 15; // Rough estimate
            }
            else
            {
                connectionStatus = (Icons.Material.Filled.Error, Color.Error, "Fehler");
            }
        }
        catch (Exception ex)
        {
            connectionStatus = (Icons.Material.Filled.Warning, Color.Warning, "Offline");
            Snackbar.Add($"Verbindung zu Gitea fehlgeschlagen: {ex.Message}", Severity.Warning);
        }
        finally
        {
            isLoading = false;
            lastSyncTime = DateTime.Now;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        await LoadDashboardData();
        Snackbar.Add("Dashboard-Daten aktualisiert", Severity.Info);
    }

    private void NavigateToRepository(GiteaRepository repo)
    {
        if (repo?.Owner?.Login != null && !string.IsNullOrEmpty(repo.Name))
        {
            var url = $"/git/repository/{repo.Owner.Login}/{repo.Name}";
            // Navigation would be handled by NavigationManager if injected
        }
    }
}